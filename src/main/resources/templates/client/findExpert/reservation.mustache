<style>
    /* Calendar Container */
    .reservation-container .reservation-calendar {
        display: flex;
        justify-content: space-between;
    }

    /* Month Navigation */
    .reservation-container .reservation-month {
        text-align: center;
        width: 700px;
        border: 1px solid #ddd;
        padding: 50px;
        border-radius: 5px;
    }

    .reservation-container .reservation-month h3 {
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 40px;
    }

    .reservation-container .reservation-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-top: 10px;
    }

    .reservation-container .reservation-days div {
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        position: relative;
    }

    .reservation-container .reservation-days .reservation-selected {
        color: #fff;
    }

    .reservation-container .reservation-days .reservation-selected:before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background-color: #00bbba;
        color: white;
        z-index: -1;
    }

    /* Times */
    .reservation-container .reservation-times {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: calc((100% - 750px));
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-left: 50px;
        padding: 50px 20px;
    }

    .reservation-container .reservation-times h3 {
        font-weight: 700;
        font-size: 18px;
    }

    .reservation-container .reservation-times button {
        padding: 10px;
        border: none;
        border-radius: 5px;
        background-color: #bfe7e7;
        cursor: pointer;
        height: 40px;
        width: calc((100% - 15px) / 4);
        margin-right: 5px;
        font-size: 16px;
        margin-bottom: 10px;
    }

    .reservation-container .reservation-times button:last-child {
        margin-right: 0;
    }

    .reservation-container .reservation-times button:hover {
        background-color: #00bbba;
        color: white;
    }

    .reservation-container .reservation-times button.active {
        background-color: #00bbba;
        color: white;
    }

    /* Navigation Buttons */
    .reservation-container .reservation-next-wrapper {
        display: flex;
        justify-content: space-between;
        width: 700px;
        margin-top: 20px;
    }

    .reservation-container .reservation-next-wrapper button {
        width: calc(50% - 10px);
        height: 40px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .reservation-container .reservation-next-wrapper button#payButton.active {
        background-color: #00bbba;
        color: white;
    }

    .reservation-container .reservation-next-wrapper button#reservation-payButton.active {
        background-color: #00bbba;
        /* 활성화된 색상 */
        color: white;
    }

    /* Styles for past dates */
    .reservation-past {
        color: #999;
        position: relative;
    }

    .reservation-past::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20%;
        height: 1px;
        background-color: #999;
    }

    /* Styles for selected date */
    .calendar .days .selected:before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background-color: #00bbba;
        color: white;
        z-index: -1;
    }
</style>

{{> layout/client-header}}

<section id="section01">
    <div class="reservation-container">
        <div class="page-wrapper">
            <h3 class="page-title mb-20 explanation own-time">
                2급) 보이스테라피 1회기권
            </h3>
            <div class="page-content">
                <div class="reservation-calendar">
                    <div class="reservation-month">
                        <h3 id="reservation-month-year"></h3>
                        <div class="reservation-days" id="reservation-days"></div>
                    </div>
                    <div class="reservation-times">
                        <h3 class="explanation time">예약 가능한 시간대</h3>
                        <div id="reservation-times"></div>
                    </div>
                </div>

                <div class="reservation-next-wrapper">
                    <button id="reservation-skipButton">건너뛰기</button>
                    <button id="reservation-payButton" disabled>결제하기</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const voucherId = urlParams.get('voucherId');
        const expertId = urlParams.get('expertId');

        // Logging for debugging
        console.log('voucherId:', voucherId);
        console.log('expertId:', expertId);

        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();
        let selectedDate = null;

        function renderCalendar(year, month) {
            const firstDay = new Date(Date.UTC(year, month, 1)).getUTCDay();
            const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
            const monthYearText = `${month + 1}월 ${year}년`;

            $('#reservation-month-year').text(monthYearText);

            const daysHtml = [];
            for (let i = 0; i < firstDay; i++) {
                daysHtml.push('<div></div>');
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(Date.UTC(year, month, i));
                const pastClass = date < today ? 'reservation-past' : '';
                const todayClass = date.toDateString() === today.toDateString() ? 'reservation-today' : '';
                daysHtml.push(`<div class="reservation-day ${pastClass} ${todayClass}" data-date="${i}" data-full-date="${date.toISOString().split('T')[0]}">${i}</div>`);
            }

            $('#reservation-days').html(`
        <div class="main-color reservation-disabled reservation-day">일</div>
        <div class="main-color reservation-disabled reservation-day">월</div>
        <div class="main-color reservation-disabled reservation-day">화</div>
        <div class="main-color reservation-disabled reservation-day">수</div>
        <div class="main-color reservation-disabled reservation-day">목</div>
        <div class="main-color reservation-disabled reservation-day">금</div>
        <div class="main-color reservation-disabled reservation-day">토</div>
        ${daysHtml.join('')}
    `);

            // Attach click event to each day
            $('#reservation-days .reservation-day').not('.reservation-past').click(function () {
                $('#reservation-days .reservation-day').removeClass('reservation-selected');
                $(this).addClass('reservation-selected');
                const fullDate = $(this).data('full-date');
                console.log("Selected full date:", fullDate); // 로그 추가
                displayTimes(fullDate);
                $('#reservation-payButton').prop('disabled', true).removeClass('active');
            });

            // Select the first available day automatically
            selectFirstAvailableDay();
        }

        function displayTimes(fullDate) {
            $.ajax({
                url: '/api/available-times',
                method: 'GET',
                data: {date: fullDate, expertId: expertId},
                success: function (times) {
                    console.log("Available times for date", fullDate, ":", times);  // 로그 추가
                    if (times.length === 0) {
                        $('#reservation-times').html('<p>해당 날짜에 예약 가능한 시간이 없습니다.</p>');
                    } else {
                        $('#reservation-times').html(times.map(time => `<button class="reservation-time-btn" data-time="${time}">${time}</button>`).join(''));

                        // Attach click event to each time button
                        $('#reservation-times .reservation-time-btn').click(function () {
                            $('#reservation-times .reservation-time-btn').removeClass('active');
                            $(this).addClass('active');
                            $('#reservation-payButton').prop('disabled', false).addClass('active');
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Failed to load available times:", error);
                    $('#reservation-times').html('<p>시간을 로드하는데 실패했습니다.</p>');
                }
            });
        }

        function selectFirstAvailableDay() {
            // Select the first day after today
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate());

            const firstAvailableDay = $('#reservation-days .reservation-day').filter(function () {
                const dayDate = new Date(currentYear, currentMonth, $(this).data('date'));
                return dayDate >= tomorrow;
            }).first();

            if (firstAvailableDay.length) {
                firstAvailableDay.addClass('reservation-selected');
                selectedDate = firstAvailableDay.data('date');
                const fullDate = firstAvailableDay.data('full-date');
                displayTimes(fullDate);
                console.log("First available day selected:", selectedDate);
            } else {
                console.log("No available day found.");
            }
        }

        renderCalendar(currentYear, currentMonth);

        // Navigation buttons
        $('#reservation-prevMonth').click(function () {
            if (currentMonth > 0) {
                currentMonth--;
            } else {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
        });

        $('#reservation-nextMonth').click(function () {
            if (currentMonth < 11) {
                currentMonth++;
            } else {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentYear, currentMonth);
        });

        // 결제하기 버튼 활성화 시 색상 변경
        $('#reservation-payButton').click(function () {
            if (!$(this).prop('disabled')) { // 버튼이 활성화된 경우에만 색상 변경
                $(this).css('background-color', '#00bbba').css('color', 'white');
            }
        });
    });
    ;
    ;
</script>
{{> layout/footer}}
